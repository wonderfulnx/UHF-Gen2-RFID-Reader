% Reads in data in `rxdma` file to record the EPC IDs
% rxdma file is generated by ad9361_rfidreader.grc
% Put the decoded results in dma0
% Check the final result in `reader` struct.

% remember to set this sample rate as 8 * BLF, in order to correctly
% calculate the time used.
sample_rate = 0.32e6;

f = fopen('rxdma', 'rb');
values = fread(f, Inf, 'uint16');
fclose(f);
values = uint32(values);
decode_data = bitshift(values(1:4:end), 16) + values(2:4:end);

reader = struct();

count_reg = 1;
bits = repmat(' ', 1, 128);
len = length(decode_data);
rn16_count = 0;
epc_count = 0;
crc_16 = comm.CRCGenerator([16 12 5 0], 'InitialConditions', ones(1, 16), 'DirectMethod', true);

for i = 1:len
    tmp = bitget(decode_data(i), 1:4);
    result = tmp(1);
    start = tmp(2);
    target = tmp(3);
    valid = tmp(4);
    if valid
        if start
            last_count = 1;
        else
            last_count = count_reg;
        end
        if result
            bits(last_count) = '1';
        else
            bits(last_count) = '0';
        end
        count_reg = last_count + 1;
        if target == 0 && last_count == 16       % ReaderReceive.RN16
            rn16 = repmat(' ', 1, 4);
            for b = 1:2:4
                rn16(b:b+1) = dec2hex(bin2dec(bits(floor(b/2)*8+1:(floor(b/2)+1)*8)), 2);
            end
            % fprintf("[RN16 %d]:%s \n", rn16_count, rn16)
            rn16_count = rn16_count + 1;
            try
                reader.('rn16') = reader.('rn16') + 1;
            catch
                reader.('rn16') = 1;
            end
            count_reg = 1;
        elseif target == 1 && last_count == 128  % ReaderReceive.EPC
            epc = repmat(' ', 1, 32);
            for b = 1:2:32
                epc(b:b+1) = dec2hex(bin2dec(bits(floor(b/2)*8+1:(floor(b/2)+1)*8)), 2);
            end
            epc_count = epc_count + 1;
            % Check crc
            
            crc_result = crc_16((bits > '0')')';
            residue = dec2hex(uint16(bin2dec(char('0' + crc_result(129:144)))), 4);
            conc = ['epc_' epc];
            try
                reader.('epc').(conc).('count') = reader.('epc').(conc).('count') + 1;
            catch
                reader.('epc').(conc).('count') = 1;
                reader.('epc').(conc).('err') = 0;
            end
            
            if residue ~= "1D0F"
                fprintf("[EPC %d]:%s---CRC Wrong \n", epc_count, epc)
                reader.('epc').(conc).('err') = reader.('epc').(conc).('err')  + 1; % CRC wrong
            else
                fprintf("[EPC %d]:%s \n", epc_count, epc)
            end
            count_reg = 1;
        end
    end
end

time_cost = length(decode_data)/sample_rate;
fprintf("time: %.2f s\n", time_cost);
fprintf("rate: %.2f per s\n", epc_count / time_cost);
